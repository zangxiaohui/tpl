!function(a,b){"use strict";var c=a.WindVane,d=Array.prototype.slice,e="classList"in document.body,f=/_(\d+x\d+|cy\d+i\d+|sum|m|b)?(xz|xc)?(q\d+)?(s\d+)?\.jpg?/i,g=/^(https?:)?\/\/.*(?:alicdn|taobaocdn|taobao)\.(com|net)\/.*(?:\.(jpg|png|gif|jpeg|webp))?$/gi,h=a.navigator.userAgent,i=h?null!=h.match(/TB(IOS|ANDROID)/g):!1,j={getWebpImg:function(a,b,c){if(a){if(null==a.match(g))return a;c=c||"",b=b||"";var d=a.lastIndexOf("_."),e=-1!=d?a.slice(d+2):null,h=e&&"webp"==e.toLowerCase()?!0:!1,i=h?a.slice(0,d):a,j=i.match(f);if(null!=j)var k=j[1]||b,l=j[3]||c,m=i.replace(f,"_"+k+(j[2]||"")+l+(j[4]||"")+".jpg");else(b||c)&&(i+="_",i+=b,i+=c,i+=".jpg"),m=i;return h&&m+"_.webp"||m}},clearImgSrc:function(a){return a&&"string"==typeof a?a.replace(f,""):void 0},hasClass:function(a,b){if(a){var c;return c=e?a.classList.contains(b):a.className.split(" ").indexOf(b)>-1}},addClass:function(a,b){a&&(e?a.classList.add(b):a.className=a.className+" "+b)},removeClass:function(a,b){a&&(e?a.classList.remove(b):a.className=a.className.replace(b,""))},each:function(a,b){for(var c=0,d=a.length;d>c;c++)if(b.call(a[c],c,a[c])===!1)return},map:function(a,b){var c,d=[];return this.each(a,function(a,e){c=b.call(this,e),null!=c&&d.push(c)}),d},indexOf:function(a,b){return this.each(a,function(a,c){return c===b?a:void 0}),-1},difference:function(a,b){return b?a.filter(function(a){return-1===b.indexOf(a)}):a},without:function(a){return this.difference(a,d.call(arguments,1))},every:function(a,b){return a.every?a.every(b):(this.each(a,function(a,c){return b.call(null,c)?!0:void 0}),!1)},concat:function(){for(var a=arguments,b=[],c=0,d=a.length;d>c;c++)for(var e=0,f=a[c].length;f>e;e++)b.push(a[c][e]);return b},fireEvent:function(a,b,c){var d=document.createEvent("HTMLEvents");if(d.initEvent(b,!0,!0),"object"==typeof c)for(var e in c)d[e]=c[e];a.dispatchEvent(d)},showNote:function(a){i&&c?c.call("WVUIToast","toast",a,function(a){},function(b){alert(a)}):alert(a)}};b.sku=lib.sku||{},b.sku.tools=j}(window,window.ctrl||(window.ctrl={})),function(a,b){"use strict";function c(a){a=a||{};var b=this,c=document.createDocumentFragment(),e=document.createElement("div");c.appendChild(e),b.addEventListener=function(){e.addEventListener.apply(e,arguments)},b.fireEvent=function(a,b){d.fireEvent(e,a,b)},b.removeEventListener=function(){e.removeEventListener.apply(e,arguments)},b.remove=function(){e.parentNode&&e.parentNode.removeChild(e)},b.element=e,b.root=c,this.model={};var f,g=a.close,h=a.showQuantity;Object.defineProperty(b,"viewModel",{get:function(){return f},set:function(a){if(!a)throw new Error("Non expected value");f=a,f._close=g,f._showQuantity=h,b.syncViewModel()}}),a.viewModel&&(this.viewModel=a.viewModel);var i;Object.defineProperty(b,"defaultSku",{get:function(){return i},set:function(a){a&&(i=b.model.skuId=a,b.dSelected())}}),b.priceType=a.priceType||0}var d=b.sku.tools,e="配送方式";c.prototype={syncViewModel:function(){this.destroy();var a=this.viewModel,b=a.featureMap;this.poiInfo=b?b.poiInfo:null;var c=a.skuModel;if(!c)throw new Error("无sku选项");var e=a.itemControl;if(e){this.skuControl=e.skuControl;var f=this.unitControl=e.unitControl;f&&(this.model.buySupport=this.unitControl.buySupport,this.model.cartSupport=this.unitControl.cartSupport)}this.model.quantity=a.itemInfoModel.quantity;var g=this.skuProps=c.skuProps||[];this.ppathIdmap=c.ppathIdmap||{},this.skus=c.skus||{},this.cascadeSkuInfo=c.cascadeInfo,g.length?(this.isSkuProps=!0,this.propNames=d.map(g,function(a){return a.propName}),a._propNames='还未选 <span class="dpt-gray">'+this.propNames.join(",")+"</span>"):(a._propNames="",this.propNames=[]),this.model.skuText=this.propNames.join(","),this.poiInfo&&(a._propNames='已选："送货上门" '+a._propNames),this.element.innerHTML=this.template(a),this.afterRender()},dSelected:function(){var a=this,b=a.ppathIdmap;if(!b)throw new Error("viewModel is not exist");var c,e=a.defaultSku;for(var f in b)if(b[f]==e){c=f;break}if(c)for(var g=c.split(";"),h=0,i=g.length;i>h;h++)d.fireEvent(a.element.querySelector('span[data-id="'+g[h]+'"]'),"tap")},template:function(a){var b=a.itemInfoModel,c=b.priceUnits,e=a.skuModel,f="",g=c[0].rangePrice||c[0].price;1==this.priceType&&c.length>1&&(g=c[1].rangePrice||c[1].price),f+='<div class="d-prop">',f+='<div class="dp-top">',f+='<div class="dpt-l">',f+='<p><img class="J_pimg" src="'+d.getWebpImg(b.picsPath[0],"100x100","q90")+'"></p>',f+="</div>",f+='<div class="dpt-r">',f+='<div class="dpt-rt" id="J_detail_skupr">',f+='<span class="dpt-pri">&yen;'+g+"</span>(库存"+b.quantity+"件)",f+="</div>",f+='<span class="dpt-opt J_skutext">'+a._propNames+"</span>",f+="</div>",a._close&&(f+='<div class="dpt-c J_dclose">',f+="</div>"),f+="</div>";var h=e.cascadeInfo,i=h?h.topSkuPVMap:null,j=e.skuProps;if(f+='<div class="J_skuEle">',f+='<div class="J_skuScroll">',i||j&&j.length){var k,l;if(f+='<div class="dp-cont">',i)for(var m in i){if(k=i[m],l=k.length,f+='<div class="dpc-p">',f+='<div class="dpc-tl">'+i[m][0].propertyText+"</div>",h.rootPropIds.indexOf(m)>-1){f+='<div class="dpc-pr J_psel">',f+='<select class="dpc-sl J_select">';for(var n=0;l>n;n++)f+='<option value="'+k[n].valueId+'" data-id="'+k[n].propertyValueId+'" data-name="'+k[n].propertyText+'" >'+k[n].actualValueText+"</option>";f+="</select>";for(var n=0;n<h.casPropDepthMap[m]-1;n++)f+='<select class="dpc-sl J_select"></select>';f+="</div>"}else{f+='<div class="dpc-pr" propname="'+i[m][0].propertyText+'">';for(var o=0;l>o;o++)f+='<span class="J_skuspan"',k[o].imgUrl&&(f+=' data-img="'+k[o].imgUrl+'"'),k[o].propertyValueId&&(f+=' data-id="'+k[o].propertyValueId+'"'),f+=">"+k[o].actualValueText+"</span>";f+="</div>"}f+="</div>"}else for(var n=0,p=j.length;p>n;n++){f+='<div class="dpc-p">',f+='<div class="dpc-tl">'+j[n].propName+"</div>",f+='<div class="dpc-pr" propname="'+j[n].propName+'">';for(var o=0,q=j[n].values.length;q>o;o++)f+='<span class="J_skuspan"',j[n].values[o].imgUrl&&(f+=' data-img="'+j[n].values[o].imgUrl+'"'),j[n].values[o].valueId&&(f+=' data-id="'+j[n].propId+":"+j[n].values[o].valueId+'"'),f+=">"+j[n].values[o].name+"</span>";f+="</div>",f+="</div>"}f+="</div>"}return a._showQuantity&&(f+='<div class="dp-num">',f+='<div class="dpn-l">',f+="购买数量",f+="</div>",f+='<div class="dpn-r">',f+='<span class="dpn-del J_buydel"></span>',f+='<span class="dpn-buy J_buytext">1</span>',f+='<span class="dpn-add J_buyadd"></span>',f+="</div>",f+="</div>"),f+=this.sepTemp(a),f+="</div>",f+="</div>",f+='<div class="dp-btom">',f+='<div><span id="J_skubton" class="dp-bton">确定</span></div>',f+="</div>",f+="</div>"},sepTemp:function(a){var b="",c=this.poiInfo;return c&&(b+='<div id="J_otologis" class="dp-oto">',b+='<div class="dpc-p">',b+='<div class="dpc-tl">'+e+"</div>",b+='<div class="dpc-pr" propname="'+e+'">',b+='<span data-type="post" class="J_otospan o-sel">送货上门</span>',b+='<span data-type="visit" class="J_otospan">门店自提</span>',b+="</div>",b+="</div>",b+='<div id="J_shoplocal" class="none dpc-sp">',b+='<div class="dps-spl">',b+=c.title||"",b+="</div>",b+='<div class="dps-spr J_smap" href="'+(c.mapUrl||"")+'">',b+=c.location||"",b+="</div>",b+="</div>",b+="</div>",this.fireEvent("addParams",{data:{delivery_method:"post"}})),b},afterRender:function(){var a=this,b=a.element;a.sInput=b.querySelector(".J_buytext"),a.simg=b.querySelector(".J_pimg"),a.skuSel=b.querySelector(".J_skutext"),a.skuLap=b.querySelector("#J_detail_skupr"),a.props=b.querySelectorAll(".J_skuspan"),a.originPrice=a.skuLap.innerHTML,a.originText=a.skuSel.innerHTML,a.onceSku();var c=a.cascadeSkuInfo;if(c&&c.topSkuPVMap){a.hasCascade=!0,a.selectCascade(b.querySelectorAll(".J_select")[0]);var d=0;for(var e in c.topSkuPVMap)d++;a.topSkuMapSize=d}b.addEventListener("tap",this,!1),b.addEventListener("change",this,!1)},handleEvent:function(a){var b=a.type,c=a.target,e=this;if("tap"===b)if(d.hasClass(c,"J_skuspan"))e.select(a);else if("J_skubton"===c.id)e.goOrder(a);else if(d.hasClass(c,"J_buydel"))e.buyNum(a,"del");else if(d.hasClass(c,"J_buyadd"))e.buyNum(a,"add");else if(d.hasClass(c,"J_pimg")){var f=c.src;e.fireEvent("sku:imageScale",{data:d.clearImgSrc(f)})}else d.hasClass(c,"J_dclose")?e.fireEvent("sku:close"):d.hasClass(c,"J_otospan")?e.selectOto(a):d.hasClass(c,"J_smap")&&e.fireEvent("sku:openMap",{data:c.getAttribute("href")});else"change"===b&&d.hasClass(c,"J_select")&&this.selectCascade(a)},onceSku:function(){var a=this,b=a.skuProps;if(b&&1==b.length){var c,e=a.props;d.each(e,function(b,e){c=a.ppathIdmap[e.getAttribute("data-id")],c&&a.quantityJudge(c)||d.addClass(e,"disabled")})}},buyNum:function(a,b){var c=this.sInput;if(c){var e=c.innerHTML,f=e=""!=e?parseInt(e,10):1;if("add"===b?f++:"del"===b&&f--,1>f&&(d.showNote("购买数量不能为0"),f=1),f>this.model.quantity&&(d.showNote("购买数量不能超出库存数"),f=this.model.quantity),f===e)return;c.innerHTML=f,this.model.buyNum=f,this.fireEvent("sku:addParams",{data:{quantity:f}})}},resetNum:function(){var a=this.sInput;if(a){var b=a.innerHTML,c=b=""!=b?parseInt(b,10):1;c>this.model.quantity&&(c=1),a.innerHTML=c,this.model.buyNum=c,this.fireEvent("sku:addParams",{data:{quantity:c}})}},goOrder:function(a){var b=this.model;return this.isSkuProps&&!b.skuId?void d.showNote("请选择"+b.skuText):(this.fireEvent("sku:doConfirm",{data:b}),void this.fireEvent("sku:close"))},selectOto:function(a){a.preventDefault();var b=this,c=a.target;if(!d.hasClass(c,"o-sel")){var e=c.parentNode.querySelector(".o-sel");e&&d.removeClass(e,"o-sel"),d.addClass(c,"o-sel");var f=c.getAttribute("data-type"),g=this.model.isOto="visit"===f,h=b.viewModel;if(b.isSkuProps){b.skus=g?b.poiInfo.priceAndQuanitiyInfo:h.skuModel.skus;var i=b.model.skuId;i&&b.quantityJudge(i)?b.resetSkuOpt("noreset"):b.resetSkuOpt(),b.notice()}else{var j=g?b.poiInfo.priceAndQuanitiyInfo.def:h.itemInfoModel;b.model.quantity=j.quantity,b.unitControl&&(b.model.buySupport=g?"true":b.unitControl.buySupport,b.model.cartSupport=g?"false":b.unitControl.cartSupport);var k="已选："+c.innerHTML,l='<span class="dpt-pri">&yen;'+(j.priceUnits?j.priceUnits[0].price:j.simplePrice)+"</span>(库存"+j.quantity+"件)";b.fireEvent("sku:updateView",{data:{text:k,price:l,quantity:b.model.quantity,buySupport:b.model.buySupport,cartSupport:b.model.cartSupport}}),b.skuSel.innerHTML=k,b.skuLap.innerHTML=l}b.fireEvent("sku:addParams",{data:{delivery_method:f,store_id:g?b.poiInfo.id:""}}),b.resetNum(),g?d.removeClass(document.getElementById("J_shoplocal"),"none"):d.addClass(document.getElementById("J_shoplocal"),"none")}},resetSkuOpt:function(a){var b=this,c=b.element.querySelectorAll(".sel");if(c.length){a&&"noreset"===a||d.each(c,function(a,b){d.removeClass(b,"sel")}),b.notice(),b.disable();var e=b.skuProps;e&&1==e.length&&(d.each(b.props,function(a,b){d.hasClass(b,"disabled")&&d.removeClass(b,"disabled")}),b.onceSku())}else d.each(b.props,function(a,b){d.hasClass(b,"disabled")&&d.removeClass(b,"disabled")}),b.onceSku()},selectCascade:function(a){var b=a.preventDefault;b&&a.preventDefault();var c=this,e=c.element,f=c.cascadeSkuInfo.skuCascadeMap,g=b?a.target:a,h=g.nextSibling,i=g.parentNode,j=g.options[g.selectedIndex].getAttribute("data-id"),k=f[g.value]||f[j];if(k&&k.length>0){var l=[],m=d.concat(e.querySelectorAll(".J_psel"),e.querySelectorAll(".sel"));m=m.filter(function(a){return a.parentNode!==i&&a!==i});var n=d.map(m,function(a){return a.getAttribute("data-id")});d.each(k,function(a,b){if(n&&n.length>0){var e=!1;if(d.each(n,function(a,d){for(var f in c.ppathIdmap)if(f.indexOf(d)>-1&&f.indexOf(b.propertyValueId)>-1){e=!0;break}}),!e)return}var f="";i.getAttribute("data-id")===b.propertyValueId&&(f='selected="selected"'),l.push('<option value="'+b.valueId+'" '+f+' data-id="'+b.propertyValueId+'" data-name="'+b.propertyText+'">'+b.actualValueText+"</option>")}),h&&(h.innerHTML=l.join(""))}else h&&(h.innerHTML="");h?b?d.fireEvent(h,"change"):c.selectCascade(h):(i.setAttribute("data-id",g.options[g.selectedIndex].getAttribute("data-id")),c.notice(),c.disable(),c.fireEvent("addParams",{data:{skuId:c.model.skuId}}))},resetCascade:function(){var a=this.element;d.each(a.querySelectorAll(".J_psel"),function(a,b){d.fireEvent(b.querySelectorAll(".J_select")[0],"change")})},showImg:function(a,b){var c=a.getAttribute("data-img");c&&(b||(c=this.viewModel.itemInfoModel.picsPath[0]),this.simg.src=d.getWebpImg(c,"100x100","q90"))},select:function(a){var b=a.preventDefault;b&&a.preventDefault();var c=this,e=b?a.target:a;if(d.hasClass(e,"disabled"))return void(d.hasClass(e,"sel")&&d.removeClass(e,"sel"));var f;if(d.hasClass(e,"sel"))d.removeClass(e,"sel"),f=!1;else{var g=e.parentNode.querySelector(".sel");g&&d.removeClass(g,"sel"),d.addClass(e,"sel"),f=!0}c.showImg(e,f),c.resetCascade(),c.notice(),c.disable(e)},notice:function(){var a=this,b=a.element,c=b.querySelectorAll(".sel"),e=b.querySelectorAll(".J_select"),f=b.querySelectorAll(".J_psel").length,g=c.length+f,h=f>0?a.topSkuMapSize:0,i=a.skuProps.length,j=a.skuSel,k=a.skuLap,l=[],m=[];a.hasCascade&&d.each(e,function(a,b){var c=b.options[b.selectedIndex];l.push(c.getAttribute("data-name")),m.push(c.text)}),d.each(c,function(a,b){l.push(b.parentNode.getAttribute("propname")),m.push(b.innerHTML)}),a.poiInfo&&d.each(b.querySelectorAll(".o-sel"),function(a,b){l.push(b.parentNode.getAttribute("propname")),m.push(b.innerHTML)});var n=d.difference(a.propNames,l),o=a.originText,p=a.originPrice,q=a.model.isOto,r=(a.priceType,a.viewModel),s=r.itemInfoModel.priceUnits;a.model.skuId=null,a.model.skuSelText=null,a.model.skuPrice=null,a.model.skuPriceUnits=null;var t=a.model.quantity=q?r.featureMap.poiInfo._quantity:r.itemInfoModel.quantity;if(a.unitControl&&(a.model.buySupport=q?"true":a.unitControl.buySupport,a.model.cartSupport=q?"false":a.unitControl.cartSupport),0==g)a.model.skuText=a.propNames.join(","),a.poiInfo&&(o='已选："'+m.join(",")+'" 还未选 <span class="dpt-gray">'+n.join(",")+"</span>",p='<span class="dpt-pri">&yen;'+(q?s[0].rangePrice:s[0].price)+"</span>(库存"+t+"件)");else if(g==i||g==h){var u=d.map(c,function(a){return a.getAttribute("data-id")});h>0&&(d.map(e,function(a){var b=a.options[a.selectedIndex];u.push(b.getAttribute("data-id"))}),u=u.sort(function(a,b){return a.split(":")[0]>b.split(":")[0]}));var v=a.ppathIdmap[u.join(";")],w=a.skus[v];if(!w)return;o="已选："+d.map(m,function(a){return'"'+a+'"'}).join(",");var x=w.priceUnits,y=x?x[0].price:w.simplePrice;q||1==a.priceType&&x.length>1&&(y=x[1].price),p='<span class="dpt-pri">&yen;'+y+"</span>(库存"+w.quantity+"件)",a.model.quantity=w.quantity,a.model.skuId=v,a.model.skuSelText=m,q||(y=[y],0==a.priceType&&x.length>1&&y.push(x[1].price)),a.model.skuPrice=y,a.model.skuPriceUnits=w.priceUnits,a.skuControl&&(a.model.buySupport=q?"true":a.skuControl[v].buySupport,a.model.cartSupport=q?"false":a.skuControl[v].cartSupport),a.resetNum()}else o='已选："'+m.join(",")+'" 还未选 <span class="dpt-gray">'+n.join(",")+"</span>",a.poiInfo&&(p='<span class="dpt-pri">&yen;'+(q?s[0].rangePrice:s[0].price)+"</span>(库存"+t+"件)"),a.model.skuText=n.join(",");a.fireEvent("sku:updateView",{data:{text:o,price:p,quantity:a.model.quantity,buySupport:a.model.buySupport,cartSupport:a.model.cartSupport}}),a.fireEvent("sku:addParams",{data:{skuId:a.model.skuId}}),j.innerHTML=o,k.innerHTML=p},quantityJudge:function(a){var b=this.skus||{},c=b[a]||{};return c.quantity>0},disable:function(a){var b=this,c=b.element,e=c.querySelectorAll(".sel");if(1!=b.skuProps.length&&(d.each(b.props,function(a,b){d.removeClass(b,"disabled")}),0!=e.length||b.hasCascade)){var f=d.map(d.concat(e,c.querySelectorAll(".J_psel")),function(a){return a.getAttribute("data-id")});d.each(b.props,function(){var a=this;if(d.hasClass(a,"sel")){var e=c.querySelectorAll(".J_skuspan");e=d.concat(e).filter(function(b){return b.parentNode!==a.parentNode}),b.hasCascade&&(e=d.concat(e,c.querySelectorAll(".J_psel"))),d.each(e,function(a,c){var g=c.parentNode.querySelector(".sel"),h=g?g.getAttribute("data-id"):null,i=!1;for(var j in b.ppathIdmap)if(j.indexOf(e[a].getAttribute("data-id"))>-1&&d.every(d.without(f,h),function(a){return j.indexOf(a)>-1})&&b.quantityJudge(b.ppathIdmap[j])){i=!0;break}i?d.removeClass(e[a],"disabled"):d.addClass(e[a],"disabled")})}else b.hasCascade&&d.each(c.querySelectorAll(".J_psel"),function(c,e){var f=!1,g=a.getAttribute("data-id");for(var h in b.ppathIdmap)if(h.indexOf(g)>-1&&h.indexOf(e.getAttribute("data-id"))>-1){f=!0;break}f||d.addClass(a,"disabled")})})}},destroy:function(){this.model={},this.removeEventListener("tap",this,!1),this.removeEventListener("change",this,!1)}},b.sku=c}(window,window.ctrl||(window.ctrl={}));